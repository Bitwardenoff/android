name: Release

on:
  workflow_dispatch:

jobs:
  android:
    name: Android Build
    runs-on: windows-latest
    needs: download-artifacts
    steps:
      - name: List files in directory
        run: |
          pwd
          ls -alh

      - name: Download artifact
        uses: dawidd6/action-download-artifact@b9571484721e8187f1fd08147b497129f8972c74
        with:
          workflow: build.yml
          workflow_conclusion: success
          branch: master
          # Optional, uploaded artifact name,
          # will download all artifacts if not specified
          # and extract them in respective subdirectories
          # https://github.com/actions/download-artifact#download-all-artifacts
          # name: artifact_name

      - name: Deploy to Play Store
        if: github.event_name == 'release'
        run: ./.github/scripts/android/deploy-play.ps1
        shell: pwsh

      - name: Upload release assets
        if: github.event_name == 'release'
        run: |
          hub release edit `
            -a ./com.x8bit.bitwarden.aab `
            -a ./com.x8bit.bitwarden.apk `
            -a ./com.x8bit.bitwarden-fdroid.apk `
            -m "Version $($env:RELEASE_TAG_NAME.TrimStart('v'))" `
            $env:RELEASE_TAG_NAME
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG_NAME: ${{ github.event.release.tag_name }}


  android-ubuntu:
    name: Android Ubuntu Build
    runs-on: ubuntu-latest
    needs: android
    steps:
      - name: List files in directory
        run: |
          pwd
          ls -alh

      - name: Download artifact
        uses: dawidd6/action-download-artifact@b9571484721e8187f1fd08147b497129f8972c74
        with:
          workflow: build.yml
          workflow_conclusion: success
          branch: master
          # Optional, uploaded artifact name,
          # will download all artifacts if not specified
          # and extract them in respective subdirectories
          # https://github.com/actions/download-artifact#download-all-artifacts
          # name: artifact_name

      - name: Deploy to gh-pages
        if: github.event_name == 'release'
        run: npm run deploy


  ios:
    name: iOS Build
    runs-on: macos-latest
    needs: download-artifacts
    steps:
      - name: List files in directory
        run: |
          pwd
          ls -alh

      - name: Download artifact
        uses: dawidd6/action-download-artifact@b9571484721e8187f1fd08147b497129f8972c74
        with:
          workflow: build.yml
          workflow_conclusion: success
          branch: master
          # Optional, uploaded artifact name,
          # will download all artifacts if not specified
          # and extract them in respective subdirectories
          # https://github.com/actions/download-artifact#download-all-artifacts
          # name: artifact_name

      - name: Deploy to App Store
        if: github.event_name == 'release'
        run: ./.github/scripts/ios/deploy-app-store.ps1
        shell: pwsh
        env:
          APPLE_ID_USERNAME: ${{ secrets.APPLE_ID_USERNAME }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}

      - name: Upload release assets
        if: github.event_name == 'release'
        run: |
          hub release edit `
            -a ./bitwarden-export/Bitwarden.ipa `
            -m "Version $($env:RELEASE_TAG_NAME.TrimStart('v'))" `
            $env:RELEASE_TAG_NAME
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG_NAME: ${{ github.event.release.tag_name }}
